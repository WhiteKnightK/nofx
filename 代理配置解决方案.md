# 代理配置解决方案

## 🔍 问题描述

**场景**：
- ✅ 开代理 → 可以访问Binance，但连不上MySQL
- ✅ 不开代理 → 可以连MySQL，但连不上Binance
- ❌ **两头堵！**

## ✅ 解决方案：配置NO_PROXY环境变量

### 方法1：在启动时设置环境变量（推荐）

```bash
cd /home/master/code/nofx/nofx

# 设置代理（用于访问Binance）
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890

# 设置NO_PROXY排除MySQL和本地服务
export NO_PROXY="localhost,127.0.0.1,*.rds.amazonaws.com,*.mysql.rds.aliyuncs.com"

# 启动后端
go run main.go
```

### 方法2：创建启动脚本

创建 `start_with_proxy.sh`：

```bash
#!/bin/bash

cd /home/master/code/nofx/nofx

# 代理配置（根据你的实际代理地址修改）
PROXY_HOST="127.0.0.1"
PROXY_PORT="7890"

# 设置代理
export HTTP_PROXY="http://${PROXY_HOST}:${PROXY_PORT}"
export HTTPS_PROXY="http://${PROXY_HOST}:${PROXY_PORT}"

# 排除不需要代理的地址（MySQL、本地服务等）
export NO_PROXY="localhost,127.0.0.1,*.rds.amazonaws.com,*.mysql.rds.aliyuncs.com,*.aliyuncs.com"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔧 代理配置:"
echo "   HTTP_PROXY: $HTTP_PROXY"
echo "   HTTPS_PROXY: $HTTPS_PROXY"
echo "   NO_PROXY: $NO_PROXY"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 启动后端
go run main.go
```

**使用方法**：
```bash
chmod +x start_with_proxy.sh
./start_with_proxy.sh
```

### 方法3：在.env文件中配置（如果支持）

在 `.env` 文件中添加：

```bash
# 代理配置
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890

# 排除代理的地址
NO_PROXY=localhost,127.0.0.1,*.rds.amazonaws.com,*.mysql.rds.aliyuncs.com
```

## 📋 NO_PROXY配置说明

### MySQL RDS地址格式

根据你的MySQL地址：
```
ls-de6e7fe7232cbdebdbade2d7e17161ff8fc9b7d0.cfqcmgocc1m6.ap-northeast-2.rds.amazonaws.com
```

**NO_PROXY应该包含**：
- `*.rds.amazonaws.com` - AWS RDS所有地址
- `*.mysql.rds.aliyuncs.com` - 阿里云RDS（如果使用）
- `localhost` - 本地服务
- `127.0.0.1` - 本地回环地址

### Binance地址（需要代理）

Binance的地址：
- `*.binance.com`
- `*.binanceapi.com`
- `fapi.binance.com`

**这些地址不在NO_PROXY中，会使用代理访问** ✅

## 🔧 验证配置

### 测试MySQL连接（应该不走代理）

```bash
# 设置环境变量
export NO_PROXY="*.rds.amazonaws.com,localhost,127.0.0.1"

# 测试MySQL连接
mysql -h ls-de6e7fe7232cbdebdbade2d7e17161ff8fc9b7d0.cfqcmgocc1m6.ap-northeast-2.rds.amazonaws.com -u dbmasteruser -p
```

### 测试Binance连接（应该走代理）

```bash
# 设置代理
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890

# 测试Binance API
curl https://fapi.binance.com/fapi/v1/ping
```

## 💡 关于AI API密钥问题

**错误信息**：
```
❌ 获取AI决策失败: 调用AI API失败: AI API密钥未设置，请先调用 SetDeepSeekAPIKey() 或 SetQwenAPIKey()
```

**解决方法**：
1. 登录Web界面（http://localhost:3000）
2. 进入"AI模型配置"
3. 选择DeepSeek或Qwen
4. 输入API密钥并保存

**注意**：之前解密时发现DeepSeek密钥无法解密（RSA密钥不匹配），需要重新获取：
- 访问 https://platform.deepseek.com/
- 重新生成API密钥
- 在Web界面重新配置

## 🚀 完整启动流程

```bash
# 1. 进入项目目录
cd /home/master/code/nofx/nofx

# 2. 设置代理环境变量
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890
export NO_PROXY="localhost,127.0.0.1,*.rds.amazonaws.com"

# 3. 启动后端
go run main.go

# 4. 在另一个终端启动前端
cd web
npm run dev
```

## ⚠️ 常见问题

### Q: NO_PROXY不生效？

**A**: 检查环境变量是否正确设置：
```bash
echo $NO_PROXY
```

确保包含MySQL的域名模式（如 `*.rds.amazonaws.com`）

### Q: 代理地址是什么？

**A**: 根据你的代理软件：
- Clash: `http://127.0.0.1:7890`
- V2Ray: `http://127.0.0.1:10808`
- 其他: 查看代理软件的HTTP代理端口

### Q: WSL2中代理地址不同？

**A**: WSL2中访问Windows代理：
- 获取Windows IP: `cat /etc/resolv.conf | grep nameserver | awk '{print $2}'`
- 使用: `http://<Windows_IP>:7890`

